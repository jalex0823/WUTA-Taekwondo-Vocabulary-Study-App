<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- PWA / Mobile Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WUTA Taekwondo">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-180.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icon-152.png') }}">
    <link rel="apple-touch-icon" sizes="167x167" href="{{ url_for('static', filename='icon-167.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icon-180.png') }}">
    
    <!-- General Meta -->
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="WUTA Taekwondo Vocabulary Training App for Kids">

    <!-- PWA Manifest (Android/Chrome + modern iOS support) -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <title>WUTA Taekwondo Vocabulary Trainer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="theme-arcade theme-screenshot page-home">
    <div class="container">
        <header class="app-header">
            <div class="brand-hero" aria-label="App branding">
                <picture class="brand-logo">
                    <img
                        src="{{ url_for('static', filename='images/TVTA_Logo.png') }}"
                        alt="Taekwondo Vocabulary Training App"
                        loading="eager"
                        onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/branding/logo.svg') }}';"
                    >
                </picture>
            </div>

            <div class="music-controls" aria-label="Background music controls">
                <div class="music-controls__row">
                    <span class="music-controls__label" id="bgmLabel">üéµ Music</span>
                    <button class="music-toggle" id="bgmToggle" type="button" aria-pressed="true">Music: ON</button>
                </div>
                <div class="music-controls__row">
                    <label class="music-controls__vol" for="bgmVolume">Volume</label>
                    <input id="bgmVolume" class="music-volume" type="range" min="0" max="100" step="1" value="22" />
                </div>
            </div>
        </header>

        {# Match the screenshot title Hangul (top line) #}
        {% set title_korean = {'white': 'ÏûÑ', 'yellow': 'Ïñ¥', 'orange': 'ÏÇº', 'green': 'ÏÇ¨', 'blue': 'Ïò§', 'red': 'Ïú°', 'purple': 'Ïπ†', 'brown': 'Ìåî', 'black': 'Íµ¨'} %}
        {% set badge_korean = {'white': 'Ïùº', 'yellow': 'Ïù¥', 'orange': 'ÏÇº', 'green': 'ÏÇ¨', 'blue': 'Ïò§', 'red': 'Ïú°', 'purple': 'Ïπ†', 'brown': 'Ìåî', 'black': 'Íµ¨'} %}

        <div class="tkd-screen">
            <div class="menu-pills-card">
                <div class="tkd-list">
                {% for b in belts %}
                <a href="/belts/{{ b.belt_id }}"
                   class="belt-card belt-{{ b.belt_id }}"
                   style="--belt-color: {{ b.belt_color }}{% if b.tip_color %}; --tip-color: {{ b.tip_color }}{% endif %}"
                   data-belt-id="{{ b.belt_id }}"
                   data-total-terms="{{ b.terms|length }}">

                    <div class="belt-left" aria-hidden="true">
                        <div class="belt-badge">
                            {% if b.belt_id in badge_korean %}{{ badge_korean[b.belt_id] }}{% else %}‚òÖ{% endif %}
                        </div>
                    </div>

                    <div class="belt-body">
                        <div class="belt-title">
                            <span class="hangul">
                                {% if b.belt_id in title_korean %}{{ title_korean[b.belt_id] }}{% endif %}
                            </span>
                            <span class="meta-sep">¬∑</span>
                            {{ b.belt_name }}
                        </div>

                        <div class="belt-meta">
                            <div class="meta-row">
                                <span class="meta-icon meta-icon--steps" aria-hidden="true"></span>
                                <span><span class="belt-steps">{{ b.terms|length }}</span> Îã®Í≥Ñ</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon meta-icon--infty meta-dot--muted" aria-hidden="true"></span>
                                <span><span class="belt-learned">0</span></span>
                                <span class="meta-sep">¬∑</span>
                                <span class="belt-percent">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="belt-right" aria-hidden="true">
                        <span class="belt-action">Í≥µÎ∂ÄÌïòÍ∏∞</span>
                    </div>
                </a>
                {% endfor %}

                <a href="/my-words" class="belt-card belt-my-words" style="--belt-color: #ff9f1a" data-belt-id="my_words" data-total-terms="{{ my_words_count or 0 }}">
                    <div class="belt-left" aria-hidden="true">
                        <div class="belt-badge">‚òÖ</div>
                    </div>

                    <div class="belt-body">
                        <div class="belt-title">
                            <span class="hangul">ÎÇò</span>
                            <span class="meta-sep">¬∑</span>
                            My Words
                        </div>

                        <div class="belt-meta">
                            <div class="meta-row">
                                <span class="meta-icon meta-icon--steps" aria-hidden="true"></span>
                                <span><span class="belt-steps">{{ my_words_count or 0 }}</span> Îã®Ïñ¥</span>
                            </div>
                            <div class="meta-row">
                                <span class="meta-icon meta-icon--infty meta-dot--muted" aria-hidden="true"></span>
                                <span>Add / Import / Train</span>
                            </div>
                        </div>
                    </div>

                    <div class="belt-right" aria-hidden="true">
                        <span class="belt-action">ÎÇ¥ Îã®Ïñ¥</span>
                    </div>
                </a>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <p>üåü Practice makes perfect! üåü</p>
        </footer>
    </div>
    
    <script src="{{ url_for('static', filename='wuta_audio.js') }}"></script>
    <script>
        // Pre-load sound effects
        const clickSound = new Audio('{{ url_for("static", filename="audio/sfx/button_click.mp3") }}');
        clickSound.volume = 0.3;
        clickSound.preload = 'auto';

        const navSound = new Audio('{{ url_for("static", filename="audio/sfx/nav_swoosh.mp3") }}');
        navSound.volume = 0.25;
        navSound.preload = 'auto';

        const hoverSound = new Audio('{{ url_for("static", filename="audio/sfx/fast-punch-2047.wav") }}');
        hoverSound.volume = 0.22;
        hoverSound.preload = 'auto';
        
        // Add click sound to all belt cards
        document.addEventListener('DOMContentLoaded', () => {
            // Background music (Polar Serenade) - starts on first user gesture if enabled.
            try {
                if (window.WutaAudio && typeof window.WutaAudio.initBgm === 'function') {
                    window.WutaAudio.initBgm({
                        src: '{{ url_for("static", filename="audio/sfx/OrientalNights.mp3") }}',
                        enabledDefault: true,
                        volumeDefault: 0.22,
                        toggleId: 'bgmToggle',
                        volumeId: 'bgmVolume',
                        labelId: 'bgmLabel'
                    });
                }
            } catch (e) {}

            const canHover = window.matchMedia && window.matchMedia('(hover: hover) and (pointer: fine)').matches;
            let lastHoverAt = 0;

            document.querySelectorAll('.belt-card').forEach(card => {
                if (canHover) {
                    card.addEventListener('mouseenter', () => {
                        const now = Date.now();
                        if (now - lastHoverAt < 120) return;
                        lastHoverAt = now;
                        hoverSound.currentTime = 0;
                        hoverSound.play().catch(() => {});
                    });
                }

                card.addEventListener('click', (e) => {
                    // Allow opening in new tab/window normally.
                    if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

                    e.preventDefault();

                    clickSound.currentTime = 0;
                    clickSound.play().catch(() => {});

                    navSound.currentTime = 0;
                    navSound.play().catch(() => {});

                    // Remember where the student was last training.
                    try {
                        localStorage.setItem('wuta_last_belt', card.dataset.beltId);
                    } catch (e2) {}

                    // Give the swoosh a moment to start before navigating.
                    const href = card.getAttribute('href');
                    setTimeout(() => {
                        if (href) window.location.href = href;
                    }, 90);
                });
            });
        });
        
        // Load and display progress for each belt
        const STORAGE_KEY = 'wuta_completion_';
        
        function loadBeltProgress() {
            document.querySelectorAll('.belt-card').forEach(card => {
                const beltId = card.dataset.beltId;
                const totalTerms = parseInt(card.dataset.totalTerms);
                const learnedSpan = card.querySelector('.belt-learned');
                const percentSpan = card.querySelector('.belt-percent');
                
                // Combine viewed terms from main belt and tip belt
                let viewedTermIds = new Set();
                
                // Load main belt progress
                const mainStored = localStorage.getItem(STORAGE_KEY + beltId);
                if (mainStored) {
                    try {
                        const mainViewed = JSON.parse(mainStored);
                        mainViewed.forEach(id => viewedTermIds.add(id));
                    } catch (e) {}
                }
                
                // Load tip belt progress
                const tipStored = localStorage.getItem(STORAGE_KEY + beltId + '_tip');
                if (tipStored) {
                    try {
                        const tipViewed = JSON.parse(tipStored);
                        tipViewed.forEach(id => viewedTermIds.add(id));
                    } catch (e) {}
                }
                
                const viewedCount = viewedTermIds.size;
                const percentage = totalTerms > 0 ? Math.round((viewedCount / totalTerms) * 100) : 0;

                if (learnedSpan) learnedSpan.textContent = String(viewedCount);
                if (percentSpan) percentSpan.textContent = percentage + '%';

                // Add styling hooks based on progress
                card.classList.remove('is-complete', 'is-halfway');
                if (percentage === 100) {
                    card.classList.add('is-complete');
                } else if (percentage >= 50) {
                    card.classList.add('is-halfway');
                }
            });
        }
        
        // Load progress when page loads
        window.addEventListener('DOMContentLoaded', loadBeltProgress);

        // Keep any remaining animations, but remove auto-playing one-off intro music.
    </script>
</body>
</html>
